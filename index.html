<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30¬∞ Compleanno Angela e Francesco</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;1,600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --gold: #D4AF37; 
            --gold-light: #f9f1d8;
            --gold-dark: #aa8929;
            --white: #ffffff;
            --text-dark: #333333;
        }

        body { font-family: 'Montserrat', sans-serif; margin: 0; background: #fafafa; color: var(--text-dark); text-align: center; }
        header { background: var(--white); padding: 30px 20px 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        
        .fullscreen-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: var(--gold-dark); cursor: pointer; transition: 0.3s; padding: 5px; }
        .fullscreen-btn:hover { transform: scale(1.1); color: var(--gold); }
        .fullscreen-btn svg { width: 28px; height: 28px; }

        h1 { font-family: 'Playfair Display', serif; color: var(--gold-dark); font-size: 2.2rem; margin: 0 0 10px 0; }
        p { color: #666; font-size: 1rem; margin: 0; }

        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 15px; border-bottom: 2px solid var(--gold-light); padding-bottom: 15px; }
        .tab-btn { background: transparent; border: 2px solid var(--gold); color: var(--gold-dark); padding: 10px 20px; border-radius: 30px; font-weight: bold; cursor: pointer; transition: 0.3s; font-family: 'Montserrat', sans-serif; font-size: 0.95rem; }
        .tab-btn:hover { background: var(--gold-light); }
        .tab-btn.active { background: var(--gold); color: var(--white); box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); }

        .tab-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .upload-card { background: var(--white); max-width: 450px; margin: 30px auto; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(212, 175, 55, 0.15); border: 1px solid var(--gold-light); box-sizing: border-box; }
        .text-input { width: 85%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Montserrat', sans-serif; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        .text-input:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 8px rgba(212, 175, 55, 0.3); }
        
        input[type="file"] { display: none; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 15px; align-items: center; }
        .custom-file-upload { display: inline-block; padding: 14px 24px; cursor: pointer; border: 2px dashed var(--gold); color: var(--gold-dark); border-radius: 8px; font-weight: 600; transition: 0.3s; width: 85%; box-sizing: border-box; background: #fff; }
        .custom-file-upload:hover { background: var(--gold-light); transform: translateY(-2px); }
        .camera-btn { border: 2px solid var(--gold); background: var(--gold-light); }
        
        .btn-invia { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--white); border: none; padding: 16px 30px; border-radius: 30px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; width: 85%; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4); margin-top: 5px; }
        .btn-invia:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 0.6); }
        .btn-invia:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        
        #file-count { font-size: 0.95rem; color: #555; margin-bottom: 15px; display: block; font-weight: 600; }
        
        /* BARRA (Spazio 0 quando display: none) */
        #progress-container { display: none; margin-bottom: 20px; text-align: left; width: 85%; margin-left: auto; margin-right: auto; }
        #progress-text { font-size: 0.95rem; color: var(--gold-dark); font-weight: bold; margin-bottom: 8px; display: block; text-align: center; }
        .progress-bar-bg { width: 100%; background-color: #eee; border-radius: 10px; height: 14px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        #progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--gold-light), var(--gold)); border-radius: 10px; transition: width 0.2s ease; }

        #bacheca { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; padding: 20px; max-width: 1000px; margin: 0 auto 50px auto; }
        .photo-item { aspect-ratio: 1 / 1; overflow: hidden; border-radius: 10px; background: #eee; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .photo-item:hover { border-color: var(--gold); transform: scale(1.03); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.92); align-items: center; justify-content: center; flex-direction: column; }
        .modal-content { max-width: 90%; max-height: 65vh; border-radius: 8px; box-shadow: 0 0 25px rgba(212, 175, 55, 0.4); border: 2px solid var(--gold); margin-bottom: 15px; }
        .modal-caption { color: var(--white); font-family: 'Playfair Display', serif; font-size: 1.2rem; max-width: 80%; text-align: center; margin-bottom: 20px; min-height: 30px; }
        .close { position: absolute; top: 15px; right: 25px; color: var(--gold); font-size: 45px; font-weight: bold; cursor: pointer; transition: 0.3s;}
        .close:hover { color: var(--white); transform: scale(1.1); }
        .nav-btn { cursor: pointer; position: absolute; top: 45%; transform: translateY(-50%); width: auto; padding: 15px 20px; color: var(--gold); font-weight: bold; font-size: 30px; transition: 0.3s; user-select: none; border: none; background: rgba(0,0,0,0.4); border-radius: 50%; }
        .nav-btn:hover { background: rgba(212, 175, 55, 0.9); color: white; }
        .prev { left: 10px; }
        .next { right: 10px; }
        .download-btn { position: absolute; bottom: 25px; background: var(--gold); color: var(--white); text-decoration: none; padding: 12px 25px; border-radius: 30px; font-family: 'Montserrat', sans-serif; font-weight: bold; font-size: 1rem; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
        .download-btn:hover { background: var(--gold-dark); transform: scale(1.05); color: var(--white); }

        /* OTTIMIZZAZIONE PER SCHERMI PICCOLI (SMARTPHONE) */
        @media (max-width: 480px) {
            h1 { font-size: 1.8rem; }
            .upload-card { margin: 15px; padding: 20px; width: auto; }
            .text-input, .custom-file-upload, .btn-invia, #progress-container { width: 100%; }
            .nav-tabs { margin-top: 10px; padding-bottom: 10px; }
            .tab-btn { padding: 8px 15px; font-size: 0.85rem; }
        }

    </style>
</head>
<body>

<header>
    <button class="fullscreen-btn" onclick="toggleFullScreen()" title="Schermo Intero">
        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
    </button>
    <h1>Il 30¬∞ compleanno<br>di Angela e Francesco</h1>
    <p>Aiutateci a creare un album indimenticabile!</p>
    
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('upload')">üì∏ Carica Foto</button>
        <button class="tab-btn" onclick="switchTab('gallery')">üñºÔ∏è Bacheca Live</button>
    </div>
</header>

<div id="upload-section" class="tab-content active">
    <div class="upload-card">
        <input type="text" id="authorInput" class="text-input" placeholder="Il tuo nome (es. Zio Marco)">
        <textarea id="messageInput" class="text-input" placeholder="Lascia un augurio! (opzionale)" rows="2"></textarea>

        <div class="input-group">
            <label for="cameraInput" class="custom-file-upload camera-btn">üì∏ Scatta ora</label>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">

            <label for="photoInput" class="custom-file-upload">üñº Scegli dalla galleria</label>
            <input type="file" id="photoInput" accept="image/*" multiple>
        </div>
        
        <span id="file-count">Nessuna foto selezionata</span>

        <div id="progress-container">
            <span id="progress-text">Caricamento in corso...</span>
            <div class="progress-bar-bg"><div id="progress-bar-fill"></div></div>
        </div>

        <button id="uploadBtn" class="btn-invia" onclick="upload()">Invia all'Album</button>
    </div>
</div>

<div id="gallery-section" class="tab-content">
    <h2 style="font-family: 'Playfair Display', serif; color: var(--text-dark); margin-top: 20px;">I Nostri Ricordi</h2>
    <div id="bacheca"></div>
</div>

<div id="slideshowModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <button class="nav-btn prev" onclick="changeSlide(-1)">&#10094;</button>
    
    <img class="modal-content" id="modalImg">
    <div id="modalCaption" class="modal-caption"></div>
    
    <a id="downloadBtn" class="download-btn" target="_blank" download>‚¨áÔ∏è Salva Foto</a>
    <button class="nav-btn next" onclick="changeSlide(1)">&#10095;</button>
</div>

<script>
    let photoData = []; 
    let currentSlide = 0;
    let selectedFiles = []; 
    let lastFirstPhotoId = ""; 
    let lastPhotoCount = -1;

    window.onload = () => {
        const savedName = localStorage.getItem("guestName");
        if (savedName) document.getElementById("authorInput").value = savedName;
        
        loadGallery();
        setInterval(loadGallery, 15000); 
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId + '-section').classList.add('active');
        document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');
        if (tabId === 'gallery') loadGallery();
    }

    document.getElementById('cameraInput').addEventListener('change', function() {
        selectedFiles = Array.from(this.files);
        document.getElementById('photoInput').value = ''; 
        updateFileCount();
    });

    document.getElementById('photoInput').addEventListener('change', function() {
        selectedFiles = Array.from(this.files);
        document.getElementById('cameraInput').value = ''; 
        updateFileCount();
    });

    function updateFileCount() {
        const count = selectedFiles.length;
        document.getElementById('file-count').innerText = count === 1 ? "1 foto pronta per l'invio" : (count > 1 ? `${count} foto pronte per l'invio` : "Nessuna foto selezionata");
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    async function loadGallery() {
        if (document.getElementById('slideshowModal').style.display === 'flex') return; 

        try {
            const res = await fetch('/api/list');
            const newData = await res.json();
            
            if (newData.length !== lastPhotoCount || (newData.length > 0 && newData[0].id !== lastFirstPhotoId)) {
                photoData = newData;
                lastPhotoCount = newData.length;
                if (newData.length > 0) lastFirstPhotoId = newData[0].id;

                document.getElementById('bacheca').innerHTML = photoData.map((file, index) => `
                    <div class="photo-item" onclick="openModal(${index})">
                        <img src="${file.thumbnailLink.replace('=s220', '=s600')}" loading="lazy" alt="Foto Evento">
                    </div>
                `).join('');
            }
        } catch (e) {
            console.error("Errore aggiornamento bacheca", e);
        }
    }

    function sparaCoriandoli() {
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#D4AF37', '#ffffff', '#f9f1d8', '#aa8929'] });
    }

    async function upload() {
        const btn = document.getElementById('uploadBtn');
        const author = document.getElementById('authorInput').value;
        const message = document.getElementById('messageInput').value;
        const totalFiles = selectedFiles.length;
        const progressContainer = document.getElementById('progress-container');

        if (totalFiles === 0) return alert("Scegli prima le foto da caricare!");

        if (author) localStorage.setItem("guestName", author);

        btn.disabled = true;
        progressContainer.style.display = "block"; 
        
        progressContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        for (let i = 0; i < totalFiles; i++) {
            const file = selectedFiles[i];
            document.getElementById('progress-text').innerText = totalFiles > 1 ? `Caricamento foto ${i + 1} di ${totalFiles}...` : `Caricamento in corso...`;
            document.getElementById('progress-bar-fill').style.width = '0%';

            await new Promise((resolve) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('author', author);
                formData.append('message', message);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/upload', true);
                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) document.getElementById('progress-bar-fill').style.width = (e.loaded / e.total * 100) + '%';
                };
                xhr.onload = xhr.onerror = () => resolve();
                xhr.send(formData);
            });
        }

        progressContainer.style.display = "none";
        sparaCoriandoli();
        
        document.getElementById('messageInput').value = '';
        selectedFiles = [];
        updateFileCount();
        btn.disabled = false;
        
        setTimeout(() => {
            switchTab('gallery');
        }, 1500);
    }

    function openModal(index) {
        currentSlide = index;
        document.getElementById('slideshowModal').style.display = 'flex';
        updateModalImage();
    }

    function closeModal() {
        document.getElementById('slideshowModal').style.display = 'none';
        loadGallery(); 
    }

    function changeSlide(direction) {
        currentSlide += direction;
        if (currentSlide >= photoData.length) currentSlide = 0; 
        if (currentSlide < 0) currentSlide = photoData.length - 1; 
        updateModalImage();
    }

    function updateModalImage() {
        const photo = photoData[currentSlide];
        document.getElementById('modalImg').src = photo.thumbnailLink.replace('=s220', '=s1600');
        document.getElementById('downloadBtn').href = photo.webContentLink;
        
        const captionDiv = document.getElementById('modalCaption');
        if (photo.description) {
            captionDiv.innerHTML = photo.description.replace(/\n/g, '<br>');
        } else {
            captionDiv.innerHTML = '';
        }
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") closeModal();
        if (event.key === "ArrowRight") changeSlide(1);
        if (event.key === "ArrowLeft") changeSlide(-1);
    });
</script>
</body>
</html>
